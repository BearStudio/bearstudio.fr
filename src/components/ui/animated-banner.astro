---
import { Image } from 'astro:assets';
import type { ComponentProps } from 'astro/types';

import type { ImageMetadata } from 'astro';

import CurvedLoop from '@/components/ui/curved-loop';

interface Props {
  image: ImageMetadata;
  imageProps?: ComponentProps<typeof Image>;
  text: string;
  curvedLoopProps?: ComponentProps<typeof CurvedLoop>;
}

const props = Astro.props;

function normalizeText(input: string) {
  return input.normalize('NFKC').trim(); // tweak as needed
}

// Fowler–Noll–Vo hash algorithm 32-bit
function fnv1a32(str: string) {
  let h = 0x811c9dc5;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 0x01000193);
  }
  return h >>> 0; // unsigned
}

function mapToRange01(u32: number) {
  return u32 / 2 ** 32; // [0,1)
}

function mapToRange(u01: number, min: number, max: number) {
  return min + u01 * (max - min);
}

function textToValue(
  text: string,
  options: { min?: number; max?: number; type?: 'precise' | 'rounded' }
) {
  const t = normalizeText(text);
  const u01 = mapToRange01(fnv1a32(t));
  const value = mapToRange(u01, options.min ?? 0, options.max ?? 1);

  return options.type === 'rounded' ? Math.round(value) : value;
}

// if you want to customize the boundaries of the curve value or position,
// change the min and max
const curveAmount = textToValue(props.text, { min: -200, max: 300 });
const position = textToValue(props.text, { min: -5, max: 5 });
---

<div
  class="bg-brand-800 relative aspect-video w-full overflow-hidden rounded-lg"
>
  <!-- Background (translate3d is for safari to apply mix-blend-overlay) -->
  <Image
    class="absolute inset-0 object-cover opacity-30 mix-blend-overlay grayscale"
    src={props.image}
    alt=""
    style={{ transform: 'translate3d(0, 0, 0)' }}
    {...props.imageProps}
  />
  <div
    class={`absolute  right-0 bottom-0 left-0 flex items-center justify-center`}
    style={{
      top: `${position}rem`,
    }}
  >
    <CurvedLoop
      client:visible
      marqueeText={`${props.text} ✦ `}
      speed={1}
      curveAmount={curveAmount}
      className="absolute inset-0 fill-white"
      interactive={false}
      {...props.curvedLoopProps}
    />
  </div>
</div>
