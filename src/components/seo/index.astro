---
import { SEO } from 'astro-seo';
import type { ComponentProps } from 'astro/types';

import { entries, filter, isNonNullish, map, pipe } from 'remeda';

import { defaultLocale } from '@/i18n';
import {
  LOCALE_TERRITORY_MAP,
  parseAstroLocale,
  type Locale,
} from '@/i18n/utils';

interface Props
  extends Pick<
    ComponentProps<typeof SEO>,
    'title' | 'description' | 'noindex' | 'nofollow' | 'openGraph'
  > {
  image?: NonNullable<
    ComponentProps<typeof SEO>['openGraph']
  >['basic']['image'];
  imageAlt?: string;
  url?: NonNullable<ComponentProps<typeof SEO>['openGraph']>['basic']['url'];
  alternates: Required<Record<Locale, string | null>>;
}
// TODO: Proper Metadata
const {
  title,
  description = 'BearStudio accompagne les porteurs de projet pour les aider techniquement sur le développement web ou mobile de leurs idées.',
  image = new URL('/opengraph-image.jpg', Astro.site).toString(),
  imageAlt,
  noindex,
  nofollow,
  url = Astro.url,
  alternates,
  openGraph,
} = Astro.props;

const ogImageAlt = 'BearStudio';
const titleDefault =
  'Studio de développement normand pour porteurs de projet numérique';

const languageAlternates = pipe(
  alternates,
  entries(),
  filter(([, href]) => isNonNullish(href)),
  map(([hrefLang, href]) => ({
    hrefLang,
    href: href!, // using !, we filtered before
  }))
);
---

<SEO
  title={title ?? ''}
  titleTemplate="%s | BearStudio"
  titleDefault={titleDefault}
  description={description ?? ''}
  noindex={noindex ?? false}
  nofollow={nofollow ?? false}
  languageAlternates={languageAlternates}
  openGraph={{
    basic: {
      title: openGraph?.basic.title ?? title ?? titleDefault,
      type: 'website',
      image: image,
      url: url ?? '',
    },
    optional: {
      description,
      siteName: 'BearStudio',
      locale:
        LOCALE_TERRITORY_MAP[
          parseAstroLocale(Astro.currentLocale) ?? defaultLocale
        ],
      localeAlternate: languageAlternates
        .filter((item) => item.hrefLang !== Astro.currentLocale)
        .map((item) => LOCALE_TERRITORY_MAP[item.hrefLang]),
    },
    image: {
      alt: imageAlt ?? ogImageAlt,
      width: 2560,
      height: 1280,
    },
  }}
  twitter={{
    card: 'summary_large_image',
    title: title ?? titleDefault ?? '',
    description: description ?? '',
    image: image,
    imageAlt: imageAlt ?? ogImageAlt,
    site: '@_BearStudio',
  }}
/>
