---
import { SEO } from 'astro-seo';
import { Schema } from 'astro-seo-schema';
import type { ComponentProps } from 'astro/types';

import { entries, filter, isNonNullish, map, pipe } from 'remeda';

import { getLink } from '@/lib/link';
import { defaultLocale } from '@/i18n';
import {
  getTranslationFn,
  LOCALE_TERRITORY_MAP,
  parseAstroLocale,
  type Locale,
} from '@/i18n/utils';

import type { BreadcrumbEntry } from '../breadcrumb/utils';

interface Props
  extends Pick<
      ComponentProps<typeof SEO>,
      'noindex' | 'nofollow' | 'openGraph'
    >,
    Required<Pick<ComponentProps<typeof SEO>, 'title' | 'description'>> {
  image?: NonNullable<
    ComponentProps<typeof SEO>['openGraph']
  >['basic']['image'];
  imageAlt?: string;
  url?: NonNullable<ComponentProps<typeof SEO>['openGraph']>['basic']['url'];
  alternates: Required<Record<Locale, string | null>> | null;
  breadcrumb: Array<BreadcrumbEntry> | null;
}
const {
  title,
  description,
  image = new URL('/opengraph-image.jpg', Astro.site).toString(),
  imageAlt,
  noindex,
  nofollow,
  url = Astro.url,
  alternates,
  openGraph,
  breadcrumb,
} = Astro.props;

const locale = parseAstroLocale(Astro.currentLocale);
const t = getTranslationFn(locale);

const ogImageAlt = 'BearStudio';
const titleDefault =
  'Studio de développement normand pour porteurs de projet numérique';

const languageAlternates = isNonNullish(alternates)
  ? pipe(
      alternates,
      entries(),
      filter(([, href]) => isNonNullish(href)),
      map(([hrefLang, href]) => ({
        hrefLang,
        href: href!, // using !, we filtered before
      }))
    )
  : [];
---

<SEO
  title={title}
  titleTemplate="%s | BearStudio"
  titleDefault={titleDefault}
  description={description}
  noindex={noindex ?? false}
  nofollow={nofollow ?? false}
  languageAlternates={languageAlternates}
  openGraph={{
    basic: {
      title: openGraph?.basic.title ?? title,
      type: 'website',
      image: image,
      url: url ?? '',
    },
    optional: {
      description,
      siteName: 'BearStudio',
      locale: LOCALE_TERRITORY_MAP[locale ?? defaultLocale],
      localeAlternate: languageAlternates
        .filter((item) => item.hrefLang !== Astro.currentLocale)
        .map((item) => LOCALE_TERRITORY_MAP[item.hrefLang]),
    },
    image: {
      alt: imageAlt ?? ogImageAlt,
      width: 2560,
      height: 1280,
    },
  }}
  twitter={{
    card: 'summary_large_image',
    title,
    description,
    image,
    imageAlt: imageAlt ?? ogImageAlt,
    site: '@_BearStudio',
  }}
/>

{
  !!breadcrumb?.length && (
    <Schema
      item={{
        '@context': 'https://schema.org',
        '@type': 'BreadcrumbList',
        itemListElement: [
          {
            '@type': 'ListItem',
            position: 1,
            item: {
              '@id': getLink('/fr', locale, {}, true),
              name: t('common.nav.home'),
            },
          },
          ...breadcrumb.map((item, index) => ({
            '@type': 'ListItem' as const,
            position: index + 2,
            item: {
              '@id': getLink(
                item.link.path,
                item.locale,
                item.link.params,
                true
              ),
              name: item.label,
            },
          })),
        ],
      }}
    />
  )
}
