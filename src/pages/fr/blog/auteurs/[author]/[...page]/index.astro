---
import { getEntry } from 'astro:content';

import type { GetStaticPathsOptions } from 'astro';

import { getLink } from '@/lib/link';
import { getPeopleCollection } from '@/lib/people';
import { getPostsCollection } from '@/lib/posts';
import Pagination from '@/components/blog/pagination.astro';
import PostCard from '@/components/blog/post-card.astro';
import PostsGrid from '@/components/blog/posts-grid.astro';
import { breadcrumbEntries } from '@/components/breadcrumb/utils';
import Container from '@/components/container.astro';
import HeroContent from '@/components/hero/hero-content.astro';
import Hero from '@/components/hero/hero.astro';
import SEO from '@/components/seo/index.astro';
import { getAlternates } from '@/components/seo/utils';
import { buttonVariants } from '@/components/ui/button';
import type { Locale } from '@/i18n/utils';
import { getTranslationFn, parseAstroLocale } from '@/i18n/utils';
import MainLayout from '@/layouts/main-layout.astro';

export async function generateStaticPaths(
  params: {
    locale: Locale;
  } & GetStaticPathsOptions
) {
  const PAGE_SIZE = 24;
  const allPosts = await getPostsCollection({
    locale: params.locale,
  });

  const allAuthors = await getPeopleCollection({ locale: params.locale });

  return allAuthors.flatMap((author) => {
    if (!author.data._computed.slug) {
      return [];
    }

    const filteredPosts = allPosts.filter((post) =>
      (post.data.authors ?? []).some((a) => a.id === author.data._computed.slug)
    );

    return params.paginate(filteredPosts, {
      pageSize: PAGE_SIZE,
      params: { author: author.data._computed.slug },
    });
  });
}

export async function getStaticPaths(params: GetStaticPathsOptions) {
  return generateStaticPaths({ ...params, locale: 'fr' });
}

const locale = parseAstroLocale(Astro.currentLocale);
const t = getTranslationFn(locale);

const { page } = Astro.props;
const params = Astro.params;

const author = await getEntry('people', `${params.author}/${locale}`); // TODO with computed
const authorName = author?.data.name ?? params.author;

const breadcrumb = breadcrumbEntries(locale)((entry) => [
  entry({
    path: '/fr/blog',
    params: {},
    label: t('blog.root.breadcrumb'),
  }),
  entry({
    path: '/fr/blog/auteurs/:author',
    params: {
      author: params.author,
    },
    label: author?.data.name ?? '',
  }),
  page.currentPage > 1
    ? entry({
        path: '/fr/blog/auteurs/:author/:page',
        params: {
          author: params.author,
          page: page.currentPage.toString(),
        },
        label: `Page ${page.currentPage}`,
      })
    : undefined,
]);
---

<MainLayout>
  <SEO
    slot="seo"
    title={t('blog.author.metadata.title', { name: authorName })}
    description={t('blog.author.metadata.description', { name: authorName })}
    alternates={getAlternates('/fr/blog/auteurs/:author', {
      author: params.author,
    })}
    noindex={page.currentPage !== 1}
    breadcrumb={breadcrumb}
  />
  <Hero>
    <HeroContent
      breadcrumb={breadcrumb}
      title={t('blog.author.title', { name: authorName })}
      description={t('blog.author.description', { name: authorName })}
    />
  </Hero>
  {
    page.data.length === 0 ? (
      <Container class="py-16">
        <div class="flex flex-col gap-4">
          <h2 class="font-heading text-2xl font-bold text-balance">
            {t('blog.author.empty.title')}
          </h2>
          <p class="text-muted-foreground max-w-[50ch] text-pretty">
            {t('blog.author.empty.description', { name: authorName })}
          </p>
          <a
            href={getLink('/fr/blog', locale, {})}
            class={buttonVariants({ variant: 'secondary' })}
          >
            {t('blog.author.empty.cta')}
          </a>
        </div>
      </Container>
    ) : (
      <Container placement="overlapHero">
        <PostsGrid>
          {page.data.map((post) => (
            <PostCard post={post} />
          ))}
        </PostsGrid>
        <Pagination
          currentPage={page.currentPage}
          nextUrl={page.url.next}
          prevUrl={page.url.prev}
        />
      </Container>
    )
  }
</MainLayout>
