---
import { Schema } from 'astro-seo-schema';
import { loadRenderers } from 'astro:container';
import { render } from 'astro:content';
import { experimental_AstroContainer } from 'astro/container';
import { getContainerRenderer as mdxContainerRenderer } from '@astrojs/mdx';

import dayjs from 'dayjs';

import { getLink } from '@/lib/link';
import {
  getPostsCollection,
  getPostSlugInOtherLocale,
  type PostWithComputed,
} from '@/lib/posts';
import { breadcrumbEntries } from '@/components/breadcrumb/utils';
import Container from '@/components/container.astro';
import HeroContent from '@/components/hero/hero-content.astro';
import Hero from '@/components/hero/hero.astro';
import Prose from '@/components/prose.astro';
import SEO from '@/components/seo/index.astro';
import { FormattedDate } from '@/components/ui/formatted-date';
import { getTranslationFn, parseAstroLocale, type Locale } from '@/i18n/utils';
import MainLayout from '@/layouts/main-layout.astro';

export async function generateStaticPaths(params: { locale: Locale }) {
  const posts = await getPostsCollection({ locale: params.locale });

  return Promise.all(
    posts.map((post) => {
      return {
        params: { id: post.data._computed.slug },
        props: { post },
      };
    })
  );
}

export async function getStaticPaths() {
  return generateStaticPaths({ locale: 'fr' });
}

type Props = {
  post: PostWithComputed;
};

const { post } = Astro.props;
const { Content } = await render(post);
const url = new URL(Astro.url.pathname, Astro.site);

const locale = parseAstroLocale(Astro.currentLocale);
const t = getTranslationFn(locale);
const renderers = await loadRenderers([mdxContainerRenderer()]);
const container = await experimental_AstroContainer.create({ renderers });

// Derive Metadata from post Data
const articleBody = (await container.renderToString(Content))
  // strip html tags
  .replace(/<[^>]*>/g, '')
  .trim();
const wordCount = articleBody.split(' ').length;

const breadcrumb = breadcrumbEntries(locale)((entry) => [
  entry({
    path: '/fr/blog',
    params: {},
    label: t('blog.root.breadcrumb'),
  }),
  entry({
    path: '/fr/blog/articles/:id',
    params: {
      id: post.data._computed.slug,
    },
    label: post.data.title,
  }),
]);

const [slugFr, slugEn] = await Promise.all([
  getPostSlugInOtherLocale(post, 'fr'),
  getPostSlugInOtherLocale(post, 'en'),
]);
---

<MainLayout>
  <SEO
    slot="seo"
    title={post.data.title}
    description={post.data.metaDescription ?? ''}
    url={url}
    alternates={{
      fr: slugFr
        ? getLink('/fr/blog/articles/:id', 'fr', {
            id: slugFr,
          })
        : null,
      en: slugEn
        ? getLink('/fr/blog/articles/:id', 'en', {
            id: slugEn,
          })
        : null,
    }}
    breadcrumb={breadcrumb}
  />
  <Schema
    slot="ld+json"
    item={{
      '@context': 'https://schema.org',
      '@type': 'BlogPosting',
      articleBody,
      headline: post.data.title,
      wordCount,
      datePublished: dayjs(post.data.date).format('YYYY-MM-DD'),
      abstract: post.data.excerpt ?? '',
      isAccessibleForFree: true,
      author: post.data._computed.authors.map((author) => ({
        '@type': 'Person',
        name: author.data.name,
      })),
      keywords: post.data.tags ?? [],
    }}
  />
  <Hero image={post.data.heroImage}>
    <HeroContent breadcrumb={breadcrumb}>
      <h1
        class="font-heading text-accent max-w-[30ch] text-4xl leading-tight font-bold text-balance md:text-5xl"
      >
        {post.data.title}
      </h1>
      <div class="flex flex-col gap-0 text-sm lg:flex-row lg:gap-1">
        <div class="opacity-60">
          {t('blog.article.on')}
          <FormattedDate date={post.data.date} locale={locale} />
        </div>
        {
          !!post.data._computed.authors.length && (
            <div>
              <span class="opacity-60">{t('blog.article.by')}</span>
              {post.data._computed.authors.map((author, index) => {
                return author.data._computed.slug ? (
                  <a
                    href={getLink('/fr/equipe/:id', locale, {
                      id: author.data._computed.slug,
                    })}
                    class="font-medium opacity-80 hover:opacity-100"
                  >
                    {`${author.data.name}${index !== post.data._computed.authors.length - 1 ? ', ' : ''}`}
                  </a>
                ) : (
                  <span class="opacity-60">
                    {`${author.data.name}${index !== post.data._computed.authors.length - 1 ? ', ' : ''}`}
                  </span>
                );
              })}
            </div>
          )
        }
      </div>
    </HeroContent>
  </Hero>
  <Container>
    <Prose>
      <Content />
    </Prose>
    <div class="flex flex-col gap-0 pt-12 text-sm lg:flex-row lg:gap-1">
      <div>
        {t('blog.article.published')}
        <FormattedDate date={post.data.date} locale={locale} />
      </div>
      {
        !!post.data._computed.authors.length && (
          <div>
            <span>{t('blog.article.by')}</span>
            {post.data._computed.authors.map((author, index) => {
              return author.data._computed.slug ? (
                <a
                  href={getLink('/fr/equipe/:id', locale, {
                    id: author.data._computed.slug,
                  })}
                  class="font-medium hover:underline"
                >
                  {`${author.data.name}${index !== post.data._computed.authors.length - 1 ? ', ' : ''}`}
                </a>
              ) : (
                <span>
                  {`${author.data.name}${index !== post.data._computed.authors.length - 1 ? ', ' : ''}`}
                </span>
              );
            })}
          </div>
        )
      }
    </div>
  </Container>
</MainLayout>
