---
import { Schema } from 'astro-seo-schema';
import { getImage } from 'astro:assets';
import { getCollection } from 'astro:content';

import { getLink } from '@/lib/link';
import { getPeopleCollection } from '@/lib/people';
import { getPolaroidHref } from '@/lib/polaroids';
import { getPostsCollection } from '@/lib/posts';
import { cn } from '@/lib/tailwind/utils';
import Container from '@/components/container.astro';
import Hero from '@/components/hero/hero.astro';
import { HomePeople } from '@/components/home/home-people';
import { HomePolaroids } from '@/components/home/home-polaroids';
import { HomePosts } from '@/components/home/home-posts';
import SEO from '@/components/seo/index.astro';
import { getAlternates } from '@/components/seo/utils';
import { buttonVariants } from '@/components/ui/button';
import { Polaroid } from '@/components/ui/polaroid';
import { TiltedCard } from '@/components/ui/tilted-card';
import { getTranslationFn, parseAstroLocale } from '@/i18n/utils';
import MainLayout from '@/layouts/main-layout.astro';

const locale = parseAstroLocale(Astro.currentLocale);
const t = getTranslationFn(locale);

const polaroids = await Promise.all(
  (await getCollection('polaroids')).map(async (polaroid) => ({
    ...polaroid,
    data: {
      ...polaroid.data,
      image: await getImage({
        src: polaroid.data.src,
        width: 400,
        height: 400,
      }),
    },
  }))
);

const peopleCurrent = await Promise.all(
  (
    await getPeopleCollection({
      locale,
      status: 'current',
      limit: 6,
    })
  ).map(async (person) => {
    return {
      ...person,
      data: {
        ...person.data,
        image: person.data.picture
          ? await getImage({
              src: person.data.picture,
              width: 500,
              height: 600,
            })
          : undefined,
      },
    };
  })
);

const latestPosts = await Promise.all(
  (
    await getPostsCollection({
      locale,
      limit: 6,
    })
  ).map(async (person) => {
    return {
      ...person,
      data: {
        ...person.data,
        image: person.data.heroImage
          ? await getImage({
              src: person.data.heroImage,
              width: 1200,
              height: 800,
            })
          : undefined,
      },
    };
  })
);
---

<MainLayout>
  <SEO
    slot="seo"
    alternates={getAlternates('/fr', {})}
    title={t('home.metadata.title')}
    description={t('home.metadata.description')}
    breadcrumb={null}
  />
  <Schema
    slot="ld+json"
    item={{
      '@context': 'https://schema.org',
      '@type': 'WebPage',
      '@id': Astro.url.toString(),
      url: Astro.url.toString(),
      name: t('home.metadata.title'),
      description: t('home.metadata.description'),
    }}
  />

  <Hero contentClassName="lg:py-24">
    <div
      class="mx-auto flex w-full max-w-5xl flex-1 items-center justify-center gap-6 max-lg:pb-24 lg:gap-12"
    >
      <div
        class="flex flex-1 flex-col justify-center gap-4 max-lg:items-center max-lg:text-center lg:gap-4"
      >
        <h1
          class="font-heading text-accent max-w-[20ch] text-4xl leading-tight font-bold text-balance md:text-5xl"
        >
          {t('home.title')}
        </h1>
        <p class="max-w-[60ch] text-sm text-balance opacity-80">
          {t('home.description')}
        </p>
        <div
          class="flex max-w-sm flex-wrap gap-2 pt-4 max-lg:items-center max-lg:justify-center"
        >
          <a
            href={getLink('/fr/prestations/ux-design', locale, {})}
            class={cn(
              buttonVariants({ variant: 'secondaryOnDark', size: 'sm' })
            )}
          >
            {t('home.services.uxUiDesign')}
          </a>
          <a
            href={getLink('/fr/prestations', locale, {})}
            class={cn(
              buttonVariants({ variant: 'secondaryOnDark', size: 'sm' })
            )}
          >
            {t('home.services.webDev')}
          </a>
          <a
            href={getLink('/fr/prestations', locale, {})}
            class={cn(
              buttonVariants({ variant: 'secondaryOnDark', size: 'sm' })
            )}
          >
            {t('home.services.mobileDev')}
          </a>
          <a
            href={getLink('/fr/prestations', locale, {})}
            class={cn(
              buttonVariants({ variant: 'secondaryOnDark', size: 'sm' })
            )}
          >
            {t('home.services.projectBoost')}
          </a>
          <a
            href={getLink('/fr/prestations', locale, {})}
            class={cn(
              buttonVariants({ variant: 'secondaryOnDark', size: 'sm' })
            )}
          >
            {t('home.services.ctoSupport')}
          </a>
        </div>
      </div>

      <div
        class="relative -mr-12 grid flex-[0.8] grid-cols-2 flex-wrap items-center justify-center gap-x-8 gap-y-7 max-lg:hidden"
      >
        {
          polaroids.map(async (polaroid, index) => (
            <a
              href={getPolaroidHref(polaroid, locale)}
              class={cn(
                'flex w-full',
                index === 0 && 'translate-x-2 rotate-6',
                index === 1 && '-translate-y-2 -rotate-5',
                index === 2 && 'translate-y-2 -rotate-4',
                index === 3 && '-translate-x-1 -translate-y-2 rotate-3'
              )}
            >
              <TiltedCard
                className="w-full"
                client:load
                scaleOnHover={1.2}
                rotateAmplitude={20}
              >
                <Polaroid image={polaroid.data.image}>
                  {polaroid.data.title[locale]}
                </Polaroid>
              </TiltedCard>
            </a>
          ))
        }
      </div>
    </div>
  </Hero>

  <div class="-mt-32 w-full lg:hidden">
    <HomePolaroids client:load locale={locale} polaroids={polaroids} />
  </div>

  <Container class="gap-12">
    <div class="flex flex-col gap-4">
      <div class="flex flex-col gap-1">
        <h2 class="font-heading text-2xl font-bold">Nos experts</h2>
        <p class="max-w-[70ch] text-sm text-balance opacity-80">
          Rencontrez les ours passionnés qui donnent vie à vos projets
          numériques avec expertise et créativité.
        </p>
      </div>
      <HomePeople client:load people={peopleCurrent} locale={locale} />
    </div>

    <div class="flex flex-col gap-4">
      <div class="flex flex-col gap-1">
        <h2 class="font-heading text-2xl font-bold">Nos articles</h2>
        <p class="max-w-[70ch] text-sm text-balance opacity-80">
          Découvrez nos articles, retours d'expérience et réflexions sur le
          développement web, mobile et les bonnes pratiques du numérique.
        </p>
      </div>
      <HomePosts client:load posts={latestPosts} locale={locale} />
    </div>
  </Container>
</MainLayout>
